#cloud-config
# Tide Gateway - Secure Cloud-Init Config
# IMMUTABLE + FAIL-CLOSED design

hostname: tide-gateway

users:
  - name: root
    lock_passwd: false
    shell: /bin/ash

write_files:
  - path: /etc/network/interfaces
    permissions: '0644'
    content: |
      auto lo
      iface lo inet loopback
      
      auto eth0
      iface eth0 inet dhcp
      
      auto eth1
      iface eth1 inet static
          address 10.101.101.10
          netmask 255.255.255.0

  - path: /etc/sysctl.d/tide.conf
    permissions: '0644'
    content: |
      net.ipv4.ip_forward=1
      net.ipv6.conf.all.disable_ipv6=1
      net.ipv6.conf.default.disable_ipv6=1

  - path: /etc/tor/torrc
    permissions: '0644'
    content: |
      User tor
      DataDirectory /var/lib/tor
      SocksPort 0.0.0.0:9050
      DNSPort 0.0.0.0:5353
      TransPort 0.0.0.0:9040
      VirtualAddrNetworkIPv4 10.192.0.0/10
      AutomapHostsOnResolve 1
      Log notice syslog
      SafeLogging 1

  - path: /etc/iptables/rules-save
    permissions: '0644'
    content: |
      *nat
      :PREROUTING ACCEPT [0:0]
      :INPUT ACCEPT [0:0]
      :OUTPUT ACCEPT [0:0]
      :POSTROUTING ACCEPT [0:0]
      -A PREROUTING -i eth1 -p udp --dport 53 -j REDIRECT --to-ports 5353
      -A PREROUTING -i eth1 -p tcp --dport 53 -j REDIRECT --to-ports 5353
      -A PREROUTING -i eth1 -p tcp -j REDIRECT --to-ports 9040
      COMMIT
      *filter
      :INPUT DROP [0:0]
      :FORWARD DROP [0:0]
      :OUTPUT DROP [0:0]
      -A INPUT -i lo -j ACCEPT
      -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
      -A INPUT -i eth1 -p icmp -j ACCEPT
      -A INPUT -i eth1 -s 10.101.101.0/24 -p tcp --dport 9050 -j ACCEPT
      -A INPUT -i eth1 -s 10.101.101.0/24 -p tcp --dport 9040 -j ACCEPT
      -A INPUT -i eth1 -s 10.101.101.0/24 -p udp --dport 5353 -j ACCEPT
      -A INPUT -i eth1 -s 10.101.101.0/24 -p tcp --dport 22 -j ACCEPT
      -A INPUT -i eth0 -p udp --sport 67 --dport 68 -j ACCEPT
      -A OUTPUT -o lo -j ACCEPT
      -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
      -A OUTPUT -o eth0 -m owner --uid-owner tor -j ACCEPT
      -A OUTPUT -o eth0 -p udp --dport 67 -j ACCEPT
      -A OUTPUT -o eth0 -p udp --dport 123 -j ACCEPT
      -A OUTPUT -o eth1 -j ACCEPT
      COMMIT

  - path: /etc/local.d/tide-security.start
    permissions: '0755'
    content: |
      #!/bin/sh
      # Tide Security - Runs every boot
      sysctl -p /etc/sysctl.d/tide.conf
      iptables-restore < /etc/iptables/rules-save
      # Verify fail-closed is active
      if ! iptables -L OUTPUT -n | grep -q "DROP"; then
          iptables -P INPUT DROP
          iptables -P OUTPUT DROP
          iptables -P FORWARD DROP
          logger "TIDE: Emergency lockdown activated"
      fi
      logger "Tide: Leak-proof firewall active"

  - path: /etc/motd
    content: |
      
        ðŸŒŠ TIDE GATEWAY - SECURE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        Gateway: 10.101.101.10 | Login: root/tide
        
        ðŸ”’ FAIL-CLOSED: No clearnet leaks possible
        ðŸ”’ IMMUTABLE: Config files locked
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      

packages:
  - tor
  - iptables
  - ip6tables
  - openssh

runcmd:
  # Set password
  - echo 'root:tide' | chpasswd
  
  # SSH config
  - sed -i 's/#PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
  
  # Enable services
  - rc-update add sshd default
  - rc-update add tor default
  - rc-update add iptables default
  - rc-update add local default
  
  # Apply security now
  - sysctl -p /etc/sysctl.d/tide.conf
  - iptables-restore < /etc/iptables/rules-save
  - /etc/init.d/iptables save
  
  # Start services
  - rc-service sshd start
  - rc-service tor start
  
  # LOCK DOWN - Make configs immutable
  - chattr +i /etc/iptables/rules-save
  - chattr +i /etc/tor/torrc
  - chattr +i /etc/sysctl.d/tide.conf
  - chattr +i /etc/local.d/tide-security.start
  - chattr +i /etc/network/interfaces
  
  # Disable cloud-init from running again
  - touch /etc/cloud/cloud-init.disabled
  
  # Log completion
  - logger "Tide Gateway: Secure configuration complete"

final_message: "Tide Gateway SECURE - Immutable configs locked"
