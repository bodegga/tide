# TIDE GATEWAY - ABSOLUTE LEAK-PROOF FIREWALL
# ============================================
# Philosophy: "Route through Tor or NOTHING"
#
# - Clients CANNOT bypass Tor
# - If Tor dies, traffic DIES
# - No UDP except DNS (which goes through Tor)
# - No IPv6 whatsoever
# - No ICMP to outside world
# - Gateway itself can ONLY talk to Tor network

*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]

# All LAN TCP → Tor transparent proxy
-A PREROUTING -i eth1 -p tcp -j REDIRECT --to-ports 9040

# All LAN DNS → local dnsmasq (which forwards to Tor DNS)
-A PREROUTING -i eth1 -p udp --dport 53 -j REDIRECT --to-ports 53
-A PREROUTING -i eth1 -p tcp --dport 53 -j REDIRECT --to-ports 53

COMMIT

*filter
:INPUT DROP [0:0]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]

# ===========================================
# INPUT - What can talk TO the gateway
# ===========================================

# Loopback always allowed
-A INPUT -i lo -j ACCEPT

# Established connections
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# LAN clients can use our services
-A INPUT -i eth1 -s 10.101.101.0/24 -p udp --dport 67 -j ACCEPT
-A INPUT -i eth1 -s 10.101.101.0/24 -p udp --dport 53 -j ACCEPT
-A INPUT -i eth1 -s 10.101.101.0/24 -p tcp --dport 53 -j ACCEPT
-A INPUT -i eth1 -s 10.101.101.0/24 -p tcp --dport 9040 -j ACCEPT
-A INPUT -i eth1 -s 10.101.101.0/24 -p tcp --dport 9050 -j ACCEPT
-A INPUT -i eth1 -s 10.101.101.0/24 -p tcp --dport 22 -j ACCEPT
-A INPUT -i eth1 -s 10.101.101.0/24 -p icmp -j ACCEPT

# WAN: ONLY DHCP responses (we need an IP)
-A INPUT -i eth0 -p udp --sport 67 --dport 68 -j ACCEPT

# DROP everything else (implicit, but explicit for clarity)
-A INPUT -j DROP

# ===========================================
# FORWARD - NOTHING gets forwarded
# ===========================================
# We don't route. We PROXY. This kills any bypass attempts.

-A FORWARD -j DROP

# ===========================================
# OUTPUT - What the gateway can send out
# ===========================================

# Loopback always allowed
-A OUTPUT -o lo -j ACCEPT

# Established connections
-A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# ONLY the Tor process can talk to the internet
-A OUTPUT -o eth0 -m owner --uid-owner tor -p tcp -j ACCEPT

# DHCP client (we need to get our WAN IP)
-A OUTPUT -o eth0 -p udp --dport 67 -j ACCEPT

# NTP (Tor needs accurate time)
-A OUTPUT -o eth0 -p udp --dport 123 -m owner --uid-owner root -j ACCEPT

# Respond to LAN
-A OUTPUT -o eth1 -j ACCEPT

# BLOCK EVERYTHING ELSE FROM GATEWAY
# This means even root can't `curl` the internet directly
-A OUTPUT -o eth0 -j DROP

COMMIT
