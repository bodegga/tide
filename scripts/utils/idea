#!/usr/bin/env bash

# Tide Gateway - Idea Capture CLI
# Quick tool to manage IDEAS.md without leaving the terminal

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
IDEAS_FILE="$PROJECT_ROOT/IDEAS.md"

# Ensure IDEAS.md exists (create if missing)
if [[ ! -f "$IDEAS_FILE" ]]; then
    echo -e "${YELLOW}Creating IDEAS.md (private, local only)...${NC}"
    cat > "$IDEAS_FILE" << 'EOF'
# Tide Gateway - Development Ideas

**Status:** Private development notes (not tracked in git)  
**Purpose:** Quick capture of ideas, features, and improvements

---

## Active Ideas

<!-- Ideas will be added here automatically by ./scripts/utils/idea -->

---

## Completed Ideas

<!-- Completed ideas move here automatically -->

EOF
    echo -e "${GREEN}âœ“ Created IDEAS.md${NC}"
    echo ""
fi

# Helper functions
print_usage() {
    cat <<EOF
${CYAN}Tide Gateway - Idea Capture Tool${NC}

${YELLOW}Usage:${NC}
  idea <command> [options]

${YELLOW}Commands:${NC}
  add <title>              Add a new idea (interactive)
  quick <title>            Quick add (uses defaults: Features, Nice-to-have)
  list                     List all active ideas
  show <number>            Show details for idea #N
  done <number>            Mark idea #N as completed
  delete <number>          Delete idea #N
  stats                    Show idea statistics
  export <number>          Export idea #N as GitHub issue template
  help                     Show this help message

${YELLOW}Options:${NC}
  -c, --category <cat>     Category (Features, Improvements, Platforms, etc.)
  -p, --priority <pri>     Priority (Critical, Important, Nice-to-have)
  -d, --description <desc> Description text

${YELLOW}Examples:${NC}
  idea add "Add IPv6 support"
  idea quick "Add status API endpoint"
  idea list
  idea show 5
  idea done 5
  idea export 5 > issue.md
  idea stats

${YELLOW}Categories:${NC}
  Features, Improvements, Platforms, Documentation, Infrastructure, Security, UX

${YELLOW}Priorities:${NC}
  Critical, Important, Nice-to-have

EOF
}

get_next_id() {
    # Find the highest ID in the file
    local max_id=0
    while IFS= read -r line; do
        if [[ $line =~ \*\*#([0-9]+)\*\* ]]; then
            local id="${BASH_REMATCH[1]}"
            if (( id > max_id )); then
                max_id=$id
            fi
        fi
    done < "$IDEAS_FILE"
    echo $((max_id + 1))
}

add_idea() {
    local title="$1"
    local category="${2:-Features}"
    local priority="${3:-Nice-to-have}"
    local description="${4:-}"
    
    if [[ -z "$title" ]]; then
        echo -e "${RED}ERROR: Title required${NC}"
        exit 1
    fi
    
    local id=$(get_next_id)
    local date=$(date +%Y-%m-%d)
    
    # Find the right category section
    local section_line=$(grep -n "^### $category" "$IDEAS_FILE" | head -1 | cut -d: -f1)
    
    if [[ -z "$section_line" ]]; then
        echo -e "${RED}ERROR: Category '$category' not found${NC}"
        echo -e "${YELLOW}Available categories: Features, Improvements, Platforms, Documentation, Infrastructure, Security, UX${NC}"
        exit 1
    fi
    
    # Create temporary file with the new entry
    local temp_file=$(mktemp)
    local insert_line=$((section_line + 1))
    local line_count=0
    
    # Build the entry
    while IFS= read -r line; do
        line_count=$((line_count + 1))
        echo "$line" >> "$temp_file"
        
        # Insert after category header
        if [[ $line_count -eq $section_line ]]; then
            echo "" >> "$temp_file"
            echo "- [ ] **#$id** - $title" >> "$temp_file"
            echo "  - **Priority:** $priority" >> "$temp_file"
            echo "  - **Added:** $date" >> "$temp_file"
            if [[ -n "$description" ]]; then
                echo "  - **Description:** $description" >> "$temp_file"
            else
                echo "  - **Description:** TODO" >> "$temp_file"
            fi
        fi
    done < "$IDEAS_FILE"
    
    # Replace original file
    mv "$temp_file" "$IDEAS_FILE"
    
    echo -e "${GREEN}âœ“ Added idea #$id: $title${NC}"
    echo -e "${CYAN}  Category: $category | Priority: $priority${NC}"
    
    # Update stats
    update_stats
}

quick_add() {
    local title="$1"
    add_idea "$title" "Features" "Nice-to-have" ""
}

list_ideas() {
    local filter="${1:-}"
    
    echo -e "${CYAN}=== Active Ideas ===${NC}\n"
    
    local current_category=""
    local count=0
    
    while IFS= read -r line; do
        # Detect category headers
        if [[ $line =~ ^###[[:space:]](.+)$ ]]; then
            current_category="${BASH_REMATCH[1]}"
            if [[ "$current_category" != "Active Ideas" ]]; then
                echo -e "\n${YELLOW}$current_category:${NC}"
            fi
            continue
        fi
        
        # Parse idea lines
        if [[ $line =~ ^-[[:space:]]\[[[:space:]]\][[:space:]]\*\*#([0-9]+)\*\*[[:space:]]-[[:space:]](.+)$ ]]; then
            local id="${BASH_REMATCH[1]}"
            local title="${BASH_REMATCH[2]}"
            count=$((count + 1))
            echo -e "  ${BLUE}#$id${NC} - $title"
        fi
        
        # Parse priority
        if [[ $line =~ \*\*Priority:\*\*[[:space:]](.+)$ ]]; then
            local priority="${BASH_REMATCH[1]}"
            case "$priority" in
                Critical)
                    echo -e "      ${RED}ðŸ”´ $priority${NC}"
                    ;;
                Important)
                    echo -e "      ${YELLOW}ðŸŸ¡ $priority${NC}"
                    ;;
                *)
                    echo -e "      ${GREEN}ðŸŸ¢ $priority${NC}"
                    ;;
            esac
        fi
    done < "$IDEAS_FILE"
    
    echo -e "\n${CYAN}Total: $count ideas${NC}"
}

show_idea() {
    local id="$1"
    
    if [[ -z "$id" ]]; then
        echo -e "${RED}ERROR: ID required${NC}"
        exit 1
    fi
    
    local found=false
    local in_idea=false
    
    echo -e "${CYAN}=== Idea #$id ===${NC}\n"
    
    while IFS= read -r line; do
        if [[ $line =~ \*\*#$id\*\*[[:space:]]-[[:space:]](.+)$ ]]; then
            found=true
            in_idea=true
            local title="${BASH_REMATCH[1]}"
            echo -e "${BLUE}Title:${NC} $title"
            continue
        fi
        
        if [[ "$in_idea" == true ]]; then
            # Stop at next idea or section
            if [[ $line =~ ^-[[:space:]]\[ || $line =~ ^### ]]; then
                break
            fi
            
            # Parse fields
            if [[ $line =~ \*\*Priority:\*\*[[:space:]](.+)$ ]]; then
                echo -e "${BLUE}Priority:${NC} ${BASH_REMATCH[1]}"
            elif [[ $line =~ \*\*Added:\*\*[[:space:]](.+)$ ]]; then
                echo -e "${BLUE}Added:${NC} ${BASH_REMATCH[1]}"
            elif [[ $line =~ \*\*Description:\*\*[[:space:]](.+)$ ]]; then
                echo -e "${BLUE}Description:${NC} ${BASH_REMATCH[1]}"
            fi
        fi
    done < "$IDEAS_FILE"
    
    if [[ "$found" == false ]]; then
        echo -e "${RED}ERROR: Idea #$id not found${NC}"
        exit 1
    fi
}

mark_done() {
    local id="$1"
    
    if [[ -z "$id" ]]; then
        echo -e "${RED}ERROR: ID required${NC}"
        exit 1
    fi
    
    # Change [ ] to [x] for this idea
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "s/^- \[ \] \*\*#$id\*\*/- [x] **#$id**/" "$IDEAS_FILE"
    else
        sed -i "s/^- \[ \] \*\*#$id\*\*/- [x] **#$id**/" "$IDEAS_FILE"
    fi
    
    echo -e "${GREEN}âœ“ Marked idea #$id as done${NC}"
    
    # Update stats
    update_stats
}

delete_idea() {
    local id="$1"
    
    if [[ -z "$id" ]]; then
        echo -e "${RED}ERROR: ID required${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}WARNING: This will permanently delete idea #$id${NC}"
    read -p "Are you sure? (y/N): " confirm
    
    if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
        echo -e "${CYAN}Cancelled${NC}"
        exit 0
    fi
    
    # Find and delete the idea block (4 lines: title + 3 fields)
    local line_num=$(grep -n "^\- \[.\] \*\*#$id\*\*" "$IDEAS_FILE" | cut -d: -f1)
    
    if [[ -z "$line_num" ]]; then
        echo -e "${RED}ERROR: Idea #$id not found${NC}"
        exit 1
    fi
    
    # Delete 5 lines (idea + 3 fields + blank line)
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "${line_num},$((line_num + 4))d" "$IDEAS_FILE"
    else
        sed -i "${line_num},$((line_num + 4))d" "$IDEAS_FILE"
    fi
    
    echo -e "${GREEN}âœ“ Deleted idea #$id${NC}"
    
    # Update stats
    update_stats
}

show_stats() {
    local total=0
    local done=0
    local critical=0
    local important=0
    local nice=0
    
    while IFS= read -r line; do
        if [[ $line =~ ^-[[:space:]]\[x\] ]]; then
            done=$((done + 1))
        elif [[ $line =~ ^-[[:space:]]\[[[:space:]]\] ]]; then
            total=$((total + 1))
        fi
        
        if [[ $line =~ \*\*Priority:\*\*[[:space:]]Critical ]]; then
            critical=$((critical + 1))
        elif [[ $line =~ \*\*Priority:\*\*[[:space:]]Important ]]; then
            important=$((important + 1))
        elif [[ $line =~ \*\*Priority:\*\*[[:space:]]Nice-to-have ]]; then
            nice=$((nice + 1))
        fi
    done < "$IDEAS_FILE"
    
    echo -e "${CYAN}=== Idea Statistics ===${NC}\n"
    echo -e "${BLUE}Total Active:${NC} $total"
    echo -e "${BLUE}Completed:${NC} $done"
    echo -e ""
    echo -e "${RED}Critical:${NC} $critical"
    echo -e "${YELLOW}Important:${NC} $important"
    echo -e "${GREEN}Nice-to-have:${NC} $nice"
}

export_idea() {
    local id="$1"
    
    if [[ -z "$id" ]]; then
        echo -e "${RED}ERROR: ID required${NC}"
        exit 1
    fi
    
    local found=false
    local in_idea=false
    local title=""
    local priority=""
    local description=""
    
    while IFS= read -r line; do
        if [[ $line =~ \*\*#$id\*\*[[:space:]]-[[:space:]](.+)$ ]]; then
            found=true
            in_idea=true
            title="${BASH_REMATCH[1]}"
            continue
        fi
        
        if [[ "$in_idea" == true ]]; then
            if [[ $line =~ ^-[[:space:]]\[ || $line =~ ^### ]]; then
                break
            fi
            
            if [[ $line =~ \*\*Priority:\*\*[[:space:]](.+)$ ]]; then
                priority="${BASH_REMATCH[1]}"
            elif [[ $line =~ \*\*Description:\*\*[[:space:]](.+)$ ]]; then
                description="${BASH_REMATCH[1]}"
            fi
        fi
    done < "$IDEAS_FILE"
    
    if [[ "$found" == false ]]; then
        echo -e "${RED}ERROR: Idea #$id not found${NC}" >&2
        exit 1
    fi
    
    # Output GitHub issue template
    cat <<EOF
## Summary
$title

## Priority
$priority

## Description
$description

## Implementation Notes
- [ ] Research approach
- [ ] Implement feature
- [ ] Add tests
- [ ] Update documentation

## Related
- Idea #$id from IDEAS.md

---
*Exported from Tide Gateway idea #$id*
EOF
}

update_stats() {
    # Update the summary section in IDEAS.md
    local total=0
    local critical=0
    local important=0
    local nice=0
    
    # Count by priority
    while IFS= read -r line; do
        if [[ $line =~ ^-[[:space:]]\[[[:space:]]\] ]]; then
            total=$((total + 1))
        fi
        
        if [[ $line =~ \*\*Priority:\*\*[[:space:]]Critical ]]; then
            critical=$((critical + 1))
        elif [[ $line =~ \*\*Priority:\*\*[[:space:]]Important ]]; then
            important=$((important + 1))
        elif [[ $line =~ \*\*Priority:\*\*[[:space:]]Nice-to-have ]]; then
            nice=$((nice + 1))
        fi
    done < "$IDEAS_FILE"
    
    # Update the "Total Active Ideas" line
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "s/^- \*\*Total Active Ideas:\*\* [0-9]*/- **Total Active Ideas:** $total/" "$IDEAS_FILE"
        sed -i '' "s/^- \*\*Critical:\*\* [0-9]*/- **Critical:** $critical/" "$IDEAS_FILE"
        sed -i '' "s/^- \*\*Important:\*\* [0-9]*/- **Important:** $important/" "$IDEAS_FILE"
        sed -i '' "s/^- \*\*Nice-to-have:\*\* [0-9]*/- **Nice-to-have:** $nice/" "$IDEAS_FILE"
    else
        sed -i "s/^- \*\*Total Active Ideas:\*\* [0-9]*/- **Total Active Ideas:** $total/" "$IDEAS_FILE"
        sed -i "s/^- \*\*Critical:\*\* [0-9]*/- **Critical:** $critical/" "$IDEAS_FILE"
        sed -i "s/^- \*\*Important:\*\* [0-9]*/- **Important:** $important/" "$IDEAS_FILE"
        sed -i "s/^- \*\*Nice-to-have:\*\* [0-9]*/- **Nice-to-have:** $nice/" "$IDEAS_FILE"
    fi
}

# Main command router
case "${1:-help}" in
    add)
        shift
        
        # Parse all arguments
        title=""
        category="Features"
        priority="Nice-to-have"
        description=""
        
        # First non-option argument is the title
        while [[ $# -gt 0 ]]; do
            case "$1" in
                -c|--category)
                    category="$2"
                    shift 2
                    ;;
                -p|--priority)
                    priority="$2"
                    shift 2
                    ;;
                -d|--description)
                    description="$2"
                    shift 2
                    ;;
                *)
                    if [[ -z "$title" ]]; then
                        title="$1"
                    fi
                    shift
                    ;;
            esac
        done
        
        add_idea "$title" "$category" "$priority" "$description"
        ;;
    
    quick)
        quick_add "$2"
        ;;
    
    list)
        list_ideas
        ;;
    
    show)
        show_idea "$2"
        ;;
    
    done)
        mark_done "$2"
        ;;
    
    delete)
        delete_idea "$2"
        ;;
    
    stats)
        show_stats
        ;;
    
    export)
        export_idea "$2"
        ;;
    
    help|--help|-h)
        print_usage
        ;;
    
    *)
        echo -e "${RED}Unknown command: $1${NC}"
        echo ""
        print_usage
        exit 1
        ;;
esac
