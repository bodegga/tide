# Tide Gateway - Router Mode (Default)
# ======================================
# DHCP + Transparent Routing - Just run: docker-compose up -d
# 
# Start: docker-compose up -d
# Stop:  docker-compose down
#
# What this does:
#   - Gateway runs Tor with transparent proxy
#   - Gateway runs DHCP server (assigns IPs automatically)
#   - Clients connect and get everything configured automatically
#   - All traffic routes through Tor (no SOCKS5 config needed)

services:
  gateway:
    build:
      context: ..
      dockerfile: docker/Dockerfile.gateway
    container_name: tide-gateway-router
    hostname: tide-gateway
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    environment:
      - TIDE_MODE=${TIDE_MODE:-router}
      - TIDE_SECURITY=${TIDE_SECURITY:-standard}
      - TIDE_GATEWAY_IP=${TIDE_GATEWAY_IP:-10.101.101.10}
      - TIDE_SUBNET=${TIDE_SUBNET:-10.101.101.0/24}
      - TIDE_DHCP_START=${TIDE_DHCP_START:-10.101.101.100}
      - TIDE_DHCP_END=${TIDE_DHCP_END:-10.101.101.200}
    networks:
      tidenet:
        ipv4_address: ${TIDE_GATEWAY_IP:-10.101.101.10}
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "9050"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  tidenet:
    driver: bridge
    ipam:
      config:
        - subnet: ${TIDE_SUBNET:-10.101.101.0/24}
          gateway: 10.101.101.1
