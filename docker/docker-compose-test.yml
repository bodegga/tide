version: '3.8'

services:
  gateway:
    build:
      context: .
      dockerfile: docker/Dockerfile.gateway
    container_name: tide-gateway
    hostname: gateway
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    networks:
      tidenet:
        ipv4_address: 10.101.101.10

  client:
    image: alpine:3.21
    container_name: tide-client
    hostname: client
    cap_add:
      - NET_ADMIN
    networks:
      tidenet: {}  # No static IP - will use DHCP
    depends_on:
      - gateway
    entrypoint: >
      sh -c "
      apk add --no-cache curl &&
      echo 'âœ… Requesting IP via DHCP from gateway...' &&
      udhcpc -i eth0 -f -n &&
      echo '' &&
      echo '=== Network Configuration ===' &&
      ip addr show eth0 | grep inet &&
      echo '' &&
      echo '=== Routing Table ===' &&
      ip route &&
      echo '' &&
      echo '=== DNS Configuration ===' &&
      cat /etc/resolv.conf &&
      echo '' &&
      echo '=== Testing Tor ===' &&
      sleep 5 &&
      curl -s https://check.torproject.org/api/ip &&
      echo '' &&
      sleep infinity
      "

networks:
  tidenet:
    driver: bridge
    ipam:
      config:
        - subnet: 10.101.101.0/24
          gateway: 10.101.101.1
