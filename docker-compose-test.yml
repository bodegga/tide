version: '3.8'

services:
  gateway:
    build:
      context: .
      dockerfile: Dockerfile.gateway
    container_name: tide-gateway
    hostname: gateway
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
    networks:
      tidenet:
        ipv4_address: 10.101.101.10

  client:
    image: alpine:3.21
    container_name: tide-client
    hostname: client
    cap_add:
      - NET_ADMIN
    networks:
      tidenet:
        ipv4_address: 10.101.101.20
    depends_on:
      - gateway
    entrypoint: >
      sh -c "
      apk add --no-cache curl &&
      route del default &&
      route add default gw 10.101.101.10 &&
      echo 'nameserver 10.101.101.10' > /etc/resolv.conf &&
      echo 'âœ… Client routing through 10.101.101.10' &&
      sleep infinity
      "

networks:
  tidenet:
    driver: bridge
    ipam:
      config:
        - subnet: 10.101.101.0/24
          gateway: 10.101.101.1
